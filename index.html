<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add to Cart</title>
    <style>
        /* CSS để trang web trở nên đẹp hơn */
        .container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 20px;
        }

        .product {
            border: 1px solid #ccc;
            padding: 10px;
            margin-right: 20px;
        }

        .cart {
            border: 1px solid #ccc;
            padding: 10px;
            width: 200px;
        }

        .cart-item {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Sản phẩm 1 -->
        <div class="product">
            <h2>Sản phẩm A</h2>
            <p>ID: <span id="productId1">123</span></p>
            <p>Giá: $<span id="productPrice1">19.99</span></p>
            <button onclick="addToCart(1)">Thêm vào giỏ hàng</button>
        </div>

        <!-- Sản phẩm 2 -->
        <div class="product">
            <h2>Sản phẩm B</h2>
            <p>ID: <span id="productId2">456</span></p>
            <p>Giá: $<span id="productPrice2">29.99</span></p>
            <button onclick="addToCart(2)">Thêm vào giỏ hàng</button>
        </div>

        <!-- Giỏ hàng -->
        <div class="cart">
            <h2>Giỏ hàng</h2>
            <div id="cartItems">
                <!-- Danh sách sản phẩm trong giỏ hàng sẽ được thêm vào đây -->
            </div>
            <p>Tổng tiền: $<span id="totalPrice">0.00</span></p>
            <button onclick="checkout()">Thanh toán</button>
        </div>
    </div>

    <script>
        let cartItems = [];

        // Gọi router để lấy thông tin giỏ hàng từ server khi trang index được load
        window.addEventListener('load', () => {
            const userId = 'user123'; // Thay thế bằng userId thực tế
            fetch(`/api/cart/${userId}`)
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    data.forEach(item => {
                        cartItems.push({
                            id: item.productId, // Lưu ý: productId được sử dụng như id của sản phẩm trong giỏ hàng
                            name: item.name,
                            price: item.price
                        });
                    });
                    displayCartItems();
                })
                .catch(error => console.error('Lỗi khi lấy thông tin giỏ hàng:', error));
        });

        // Mảng để lưu trữ các mục trong giỏ hàng

        // Hàm để thêm sản phẩm vào giỏ hàng
        // Hàm để thêm sản phẩm vào giỏ hàng và gửi thông tin lên server
        function addToCart(productId) {
            let productName = document.getElementById(`productId${productId}`).textContent;
            let productPrice = parseFloat(document.getElementById(`productPrice${productId}`).textContent);
            const product = {
                id: productId,
                name: productName,
                price: productPrice
            };
            cartItems.push(product);
            console.log(cartItems);
            displayCartItems();

            // Gửi thông tin sản phẩm lên server mỗi khi nhấn nút "Thêm vào giỏ hàng"
            fetch('/add-to-cart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    userId: 'user123', // Giả sử userId là cố định 'user123' cho mục đích minh họa
                    productId: productId,
                    productName: productName,
                    productPrice: productPrice
                }),
            })
                .then(response => response.text())
                .then(data => {
                    alert(data);
                    // Không cần chuyển hướng người dùng sang trang thanh toán ở đây
                    //window.location.href = './pay.html';
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }


        // Hàm để hiển thị danh sách sản phẩm trong giỏ hàng
        // Hàm để hiển thị danh sách sản phẩm trong giỏ hàng
        function displayCartItems() {
            const cartContainer = document.getElementById('cartItems');
            const totalPriceElement = document.getElementById('totalPrice');
            cartContainer.innerHTML = ''; // Clear previous contents

            let totalPrice = 0;

            // Loop through each item in the cart and display it
            cartItems.forEach(item => {
                const cartItemElement = document.createElement('div');
                cartItemElement.classList.add('cart-item');
                cartItemElement.innerHTML = `
            <p>${item.name} - $${item.price.toFixed(2)}</p>
            <button onclick="removeFromCart(${item.id})">Xóa</button>
        `;
                cartContainer.appendChild(cartItemElement);

                // Calculate total price
                totalPrice += item.price;
            });

            // Display the total price
            totalPriceElement.textContent = totalPrice.toFixed(2);
        }


        // Function to remove item from cart
        // Hàm này xóa sản phẩm có ID cụ thể khỏi giỏ hàng trên giao diện người dùng
        function removeFromCart(productId) {
            console.log(productId);
            // Cập nhật mảng cartItems bằng cách loại bỏ sản phẩm có productId khớp
            cartItems = cartItems.filter(item => item.id !== productId);

            // Gọi hàm displayCartItems để cập nhật hiển thị giỏ hàng
            displayCartItems();

            // Gửi yêu cầu tới server để xóa sản phẩm khỏi giỏ hàng trong cơ sở dữ liệu
            fetch(`/remove-from-cart/${`user123`}/${productId}`, {
                method: 'DELETE'
            })
                .then(response => response.text())
                .then(message => {
                    console.log(message);  // In thông điệp phản hồi từ server
                })
                .catch(error => {
                    console.error('Error:', error);  // Báo lỗi nếu có
                });
        }

        function checkout() {
            window.location.href = './pay.html';
        }

    </script>

</body>

</html>